# Use RHEL 9.5 as base image
FROM registry.access.redhat.com/ubi9/ubi:latest

# Set maintainer label
LABEL maintainer="your-email@example.com" \
      description="Simple nginx server on RHEL 9.5"

# Update system and install nginx
RUN dnf update -y && \
    dnf install -y nginx && \
    dnf clean all && \
    rm -rf /var/cache/dnf

# Copy custom HTML page
COPY index.html /usr/share/nginx/html/index.html

# Set permissions (nginx user already exists)
RUN chown -R nginx:nginx /var/log/nginx /var/lib/nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html && \
    mkdir -p /var/cache/nginx && \
    chown -R nginx:nginx /var/cache/nginx

# Copy nginx configuration file
COPY nginx.conf /etc/nginx/nginx.conf

# Expose port 8080 (non-privileged)
EXPOSE 8080

# Add health check (use curl-minimal which is already installed)
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Switch to nginx user
USER nginx

# Start nginx in foreground
CMD ["nginx", "-g", "daemon off;"]
